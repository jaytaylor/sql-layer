# Test the SUM aggregate function

---
- Include: all-types-schema.yaml
---
- CreateTable: t (real_field real)
---
- Statement: INSERT INTO t VALUES (1.7976931348623157E308), (1.0E0)
---
- Statement: SELECT SUM(real_field) FROM t
- output: !select-engine { all: [[Infinity]],
                          newtypes: [[!re '3.402823[0-9]*[eE][+]?38']],             # We see REAL as a float field,
                          sys-mysql: [[1.7976931348623157e308]] } # MySQL sees it as a DOUBLE field.
# Test sum with no rows => null
---
- Statement: SELECT sum(bigint_field), sum(bigint_unsigned_field),
    sum(decimal_field), sum(double_field), sum(float_field),
    sum(integer_field), sum(numeric_field), sum(real_field),
    sum(smallint_field) FROM all_types
- output: [[null, null, null, null, null, null, null, null, null]]

# Test sum with incompatible data types
---
- Newtypes: true
---
- Statement: SELECT sum(blob_field) FROM all_types
- output: [[NULL]]
---
- Newtypes: false
---
- Statement: SELECT sum(blob_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(char_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(char_multi_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(clob_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(date_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(time_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(timestamp_field) FROM all_types
- error: [22503]
---
- Statement: SELECT sum(varchar_field) FROM all_types
- error: [22503]
---
- Newtypes: null

# Test sum with inserted rows
---
- Statement: INSERT INTO all_types
    (bigint_field, bigint_unsigned_field, decimal_field, double_field,
     float_field, integer_field, numeric_field, real_field,
     smallint_field)
    VALUES (1, 2, 3.0, 4.0, 5.0, 6, 7.0, 8.0, 9)
---
- Statement: SELECT bigint_field, bigint_unsigned_field, decimal_field,
     double_field, float_field, integer_field, numeric_field,
     real_field, smallint_field FROM all_types
- output: [[1, 2, 3, 4.0, 5.0, 6, 7, 8.0, 9]]

---
- Statement: SELECT sum(bigint_field), sum(bigint_unsigned_field),
    sum(decimal_field), sum(double_field), sum(float_field),
    sum(integer_field), sum(numeric_field), sum(real_field),
    sum(smallint_field) FROM all_types
- output: [[1, 2, 3, 4.0, 5.0, 6, 7, 8.0, 9]]

# Insert a row of nulls
---
- Statement: INSERT INTO all_types
    (bigint_field, bigint_unsigned_field, decimal_field, double_field,
     float_field, integer_field, numeric_field, real_field,
     smallint_field)
    VALUES
    (null, null, null, null, null, null, null, null, null)
---
- Statement: SELECT sum(bigint_field), sum(bigint_unsigned_field),
    sum(decimal_field), sum(double_field), sum(float_field),
    sum(integer_field), sum(numeric_field), sum(real_field),
    sum(smallint_field) FROM all_types
- output: [[1, 2, 3, 4.0, 5.0, 6, 7, 8.0, 9]]

---
- Statement: INSERT INTO all_types
    (bigint_field, bigint_unsigned_field, decimal_field, double_field,
     float_field, integer_field, numeric_field, real_field,
     smallint_field)
    VALUES
    (1, 2, 3.0, 4.0, 5.0, 6, 7.0, 8.0, 9)
---
- Statement: SELECT sum(bigint_field), sum(bigint_unsigned_field),
    sum(decimal_field), sum(double_field), sum(float_field),
    sum(integer_field), sum(numeric_field), sum(real_field),
    sum(smallint_field) FROM all_types
- output: [[2, 4, 6, 8.0, 10.0, 12, 14, 16.0, 18]]

---
- Statement: INSERT INTO all_types
    (bigint_field, decimal_field, double_field, float_field,
     integer_field, numeric_field, real_field, smallint_field)
    VALUES
    (-4, -12.0, -16.0, -20.0, -24, -28.0, -32.0, -36)
---
- Statement: SELECT sum(bigint_field), sum(decimal_field),
    sum(double_field), sum(float_field), sum(integer_field),
    sum(numeric_field), sum(real_field), sum(smallint_field) FROM
    all_types
- output: [[-2, -6, -8.0, -10.0, -12, -14, -16.0, -18]]

---
- Statement: INSERT INTO all_types
    (bigint_field, decimal_field, double_field, float_field,
     integer_field, numeric_field, real_field, smallint_field)
    VALUES
    (2, 6.0, 8.0, 10.0, 12, 14.0, 16.0, 18)
---
- Statement: SELECT sum(bigint_field), sum(decimal_field), sum(double_field),
    sum(float_field), sum(integer_field), sum(numeric_field),
    sum(real_field), sum(smallint_field) FROM all_types
- output: [[0, 0, 0.0, 0.0, 0, 0, 0.0, 0]]

---
- Statement: DELETE from all_types


## Test integer overflow and underflow
# smallint, bug 890227
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (32767)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: [[32767]]
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (1)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: [[32768]]
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (-1)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: [[32767]]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (2147483647)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: !select-engine { sys-mysql: [[32767]], newtypes: [[32767]], all: [[-1]] }
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (1)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: !select-engine { sys-mysql: [[32768]], newtypes: [[32768]], all: [[0]] }
---
- Statement: INSERT INTO all_types (smallint_field) VALUES (-1)
---
- Statement: SELECT sum(smallint_field) FROM all_types
- output: !select-engine { sys-mysql: [[32767]], newtypes: [[32767]], all: [[-1]] }
---
- Statement: DELETE FROM all_types

# int
---
- Statement: INSERT INTO all_types (integer_field) VALUES (2147483647)
---
- Statement: SELECT sum(integer_field) FROM all_types
- output: [[2147483647]]
---
- Statement: INSERT INTO all_types (integer_field) VALUES (1)
---
- Statement: SELECT bigint(sum(integer_field)) FROM all_types
- output: [[2147483648]]
---
- Statement: INSERT INTO all_types (integer_field) VALUES (-1)
---
- Statement: SELECT sum(integer_field) FROM all_types
- output: [[2147483647]]
---
- Statement: DELETE FROM all_types

# bigint
---
- Statement: INSERT INTO all_types (bigint_field) VALUES (9223372036854775807)
---
- Statement: SELECT sum(bigint_field) FROM all_types
- output: [[9223372036854775807]]
---
- Statement: INSERT INTO all_types (bigint_field) VALUES (1)
---
- Statement: SELECT sum(bigint_field) FROM all_types
- error: [55004]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (bigint_field) VALUES (-9223372036854775808)
---
- Statement: SELECT sum(bigint_field) FROM all_types
- output: [[-9223372036854775808]]
---
- Statement: INSERT INTO all_types (bigint_field) VALUES (-1)
---
- Statement: SELECT sum(bigint_field) FROM all_types
- error: [55004]

# Test unsigned integer overflow
---
- Statement: INSERT INTO all_types (bigint_unsigned_field) VALUES (9223372036854775807), (1)
---
- Statement: SELECT sum(bigint_unsigned_field) FROM all_types
- output: [[9223372036854775808]]
---
- Statement: DELETE FROM all_types

# Test double overflow
---
- Statement: INSERT INTO all_types (double_field) VALUES (1.7976931348623157E308)
---
- Statement: SELECT sum(double_field) FROM all_types
- output: [[1.7976931348623157E308]]
---
- Statement: INSERT INTO all_types (double_field) VALUES (1.7976931348623157E308)
---
- Statement: SELECT sum(double_field) FROM all_types
- error: [55004]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (double_field) VALUES
    (-1.7976931348623157E308)
---
- Statement: SELECT sum(double_field) FROM all_types
- output: [[-1.7976931348623157E308]]
---
- Statement: INSERT INTO all_types (double_field) VALUES
    (-1.7976931348623157E308)
---
- Statement: SELECT sum(double_field) FROM all_types
- error: [55004]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (double_field) VALUES ('Infinity')
---
- Statement: SELECT sum(double_field) FROM all_types
- output: !select-engine { all: [[Infinity]], newtypes: [[0.0]] }
---
- Statement: INSERT INTO all_types (double_field) VALUES ('33')
---
- Statement: SELECT sum(double_field) FROM all_types
- output: !select-engine { all: [[Infinity]], newtypes: [[33.0]] }
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (double_field) VALUES ('-Infinity')
---
- Statement: SELECT sum(double_field) FROM all_types
- output: !select-engine { all: [[-Infinity]], newtypes: [[0.0]] }
---
- Statement: INSERT INTO all_types (double_field) VALUES ('-33')
---
- Statement: SELECT sum(double_field) FROM all_types
- output: !select-engine { all: [[-Infinity]], newtypes: [[-33.0]] }

# Test float overflow
---
- Statement: INSERT INTO all_types (float_field) VALUES (3.4028234663852886E38)
---
- Statement: SELECT sum(float_field) FROM all_types
- output: [[3.4028234663852886E38]]
---
- Statement: INSERT INTO all_types (float_field) VALUES (3.4028234663852886E38)
---
- Statement: SELECT sum(float_field) FROM all_types
- output: [[6.805646932770577E38]]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (float_field) VALUES (-3.4028234663852886E38)
---
- Statement: SELECT sum(float_field) FROM all_types
- output: [[-3.4028234663852886E38]]
---
- Statement: INSERT INTO all_types (float_field) VALUES (-3.4028234663852886E38)
---
- Statement: SELECT sum(float_field) FROM all_types
- output: [[-6.805646932770577E38]]
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (float_field) VALUES ('Infinity')
---
- Statement: SELECT sum(float_field) FROM all_types
- output: !select-engine { all: [[Infinity]], newtypes: [[0.0]] }
---
- Statement: INSERT INTO all_types (float_field) VALUES ('33')
---
- Statement: SELECT sum(float_field) FROM all_types
- output: !select-engine { all: [[Infinity]], newtypes: [[33.0]] }
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (float_field) VALUES ('-Infinity')
---
- Statement: SELECT sum(float_field) FROM all_types
- output: !select-engine { all: [[-Infinity]], newtypes: [[0.0]] }
---
- Statement: INSERT INTO all_types (float_field) VALUES ('-33')
---
- Statement: SELECT sum(float_field) FROM all_types
- output: !select-engine { all: [[-Infinity]], newtypes: [[-33.0]] }

---
- Statement: DELETE FROM all_types

# Test NaN
---
- Statement: INSERT INTO all_types (double_field, float_field, real_field)
    VALUES (1.0, 1.0, 1.0)
---
- Statement: INSERT INTO all_types (double_field, float_field, real_field)
    VALUES ('Infinity', 'Infinity', 'Infinity')
---
- Statement: SELECT sum(double_field), sum(float_field), sum(real_field)
    FROM all_types
- output: !select-engine { all: [[Infinity, Infinity, Infinity]], newtypes: [[1.0, 1.0, 1.0]] }
---
- Statement: INSERT INTO all_types (double_field, float_field, real_field)
    VALUES ('-Infinity', '-Infinity', '-Infinity')
---
- Statement: SELECT sum(double_field), sum(float_field), sum(real_field)
    FROM all_types
- output: !select-engine { all: [[NaN, NaN, NaN]], newtypes: [[1.0, 1.0, 1.0]] }
---
- Statement: DELETE FROM all_types
---
- Statement: INSERT INTO all_types (double_field, float_field, real_field)
    VALUES ('Infinity', 'Infinity', 'Infinity'), ('NaN', 'NaN', 'NaN')
---
- Statement: SELECT sum(double_field), sum(float_field), sum(real_field)
    FROM all_types
- output: !select-engine { all: [[NaN, NaN, NaN]], newtypes: [[0.0, 0.0, 0.0]] }

...
